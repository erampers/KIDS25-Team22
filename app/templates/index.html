<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genesis</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="hero-page">
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <!-- swap the dot for your logo image -->
      <img src="{{ url_for('static', filename='onlylogo.png') }}" alt="GENESIS logo" class="brand-logo">
      <span>GENESIS</span>
    </div>
    <nav class="nav">
      <a>St Jude</a>
      <a>Help</a>
      <button class="cta">Team</button>
    </nav>
  </header>

  <!-- Hero -->
  <main class="hero">
    <img src="{{ url_for('static', filename='onlylogo.png') }}" alt="GENESIS logo" class="hero-logo">
    <h3 class="hero-title">Stop guessing... Start ranking!</h3>

    <!-- Prompt card (keep ONE) -->
    <section class="prompt-wrap">
      <div class="prompt-card">
        <textarea id="input" placeholder="Describe the case or notes…" aria-label="Prompt"></textarea>

        <div class="prompt-fields">
          <label class="field">
            <span class="field-label">Phenotype</span>
            <input id="phenotypeInput" type="text" placeholder="e.g., breast cancer" />
          </label>
        </div>

        <div class="prompt-actions">
          <label class="action" for="fileInput" id="fileLabel">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M16.5 6.5l-7.78 7.78a3 3 0 104.24 4.24l8.13-8.13a5 5 0 10-7.07-7.07L4.9 10.34"
                    fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <span class="label-text">Attach file</span>
            <span class="file-name" id="fileName"></span>
            <input id="fileInput" type="file" accept=".vcf,.vcf.gz" hidden>
          </label>

          <div class="count" id="count">0/10000</div>

          <button class="send" id="send" type="button" title="Send">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M5 12h10M13 8l4 4-4 4" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
      <p class="helper">Tip: Shift+Enter for newline • Enter to send</p>
    </section>

    <section class="output-wrap">
      <div class="output-card">
        <h4 class="output-title">Logs and results</h4>
        <div class="output-columns">
          <div class="output-column">
            <h5 class="output-subtitle">Logs</h5>
            <pre id="logOutput" class="log-output" aria-live="polite"></pre>
          </div>
          <div class="output-column">
            <h5 class="output-subtitle">Result</h5>
            <pre id="responseOutput" class="response-output"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick suggestion cards (optional) -->
    <!--section class="quick-grid">
      <article class="quick">
        <div class="q-title">abcd</div>
        <div class="q-desc">hehehe</div>
      </article>
      <article class="quick active">
        <div class="q-title">xyz</div>
        <div class="q-desc">hello</div>
      </article>
      <article class="quick">
        <div class="q-title">blah blah</div>
        <div class="q-desc">blah blah blu</div>
      </article>
    </section -->
  </main>

  <!-- One script block -->
  <script>
    const input = document.getElementById("input");
    const send  = document.getElementById("send");
    const count = document.getElementById("count");
    const fileInput = document.getElementById("fileInput");
    const fileLabel = document.getElementById("fileLabel");
    const fileName = document.getElementById("fileName");
    const logOutput = document.getElementById("logOutput");
    const responseOutput = document.getElementById("responseOutput");
    const phenotypeInput = document.getElementById("phenotypeInput");

    let logSource = null;

    function updateCount() { count.textContent = `${input.value.length}/10000`; }
    input.addEventListener("input", () => {
      input.style.height = "64px";
      input.style.height = Math.min(input.scrollHeight, 220) + "px";
      updateCount();
    });
    updateCount();

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      fileName.textContent = file ? file.name : "";
      fileLabel.dataset.filename = file ? "selected" : "";
    });

    function closeLogStream() {
      if (logSource) {
        logSource.close();
        logSource = null;
      }
    }

    function appendLog(line) {
      if (line === undefined || line === null) return;
      const text = line;
      logOutput.textContent += (text ? text : "") + "\n";
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function generateLogId() {
      if (window.crypto && typeof window.crypto.randomUUID === "function") {
        return window.crypto.randomUUID();
      }
      return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
    }

    function startLogStream(logId) {
      closeLogStream();
      logOutput.textContent = "";
      logSource = new EventSource(`/logs/${logId}`);
      logSource.onmessage = event => appendLog(event.data);
      logSource.addEventListener("done", () => {
        closeLogStream();
      });
      logSource.onerror = () => {
        appendLog("Log stream interrupted.");
        closeLogStream();
      };
    }

    async function sendMessage() {
      const text = input.value.trim();
      const phenotype = phenotypeInput.value.trim();
      const file = fileInput.files[0];
      if (!phenotype && !file) {
        appendLog("Error: phenotype is required when no VCF is uploaded.");
        return;
      }

      const logId = generateLogId();
      startLogStream(logId);
      responseOutput.textContent = "";

      const formData = new FormData();
      formData.append("message", text);
      formData.append("phenotype", phenotype);
      formData.append("log_id", logId);
      if (file) formData.append("vcf_file", file);

      try {
        const res = await fetch("/chat", {
          method: "POST",
          body: formData
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          const errorMsg = payload.error || res.statusText || "Request failed";
          appendLog(`Error: ${errorMsg}`);
          responseOutput.textContent = errorMsg;
          return;
        }
        if (payload.reply !== undefined) {
          responseOutput.textContent =
            typeof payload.reply === "string"
              ? payload.reply
              : JSON.stringify(payload.reply, null, 2);
        }
      } catch (error) {
        appendLog(`Network error: ${error && error.message ? error.message : error}`);
        responseOutput.textContent = "Network error";
        closeLogStream();
      } finally {
        input.value = "";
        fileInput.value = "";
        fileLabel.dataset.filename = "";
        fileName.textContent = "";
        phenotypeInput.value = "";
        updateCount();
        input.style.height = "64px";
      }
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    phenotypeInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
    send.addEventListener("click", sendMessage);
    window.addEventListener("beforeunload", closeLogStream);
  </script>
</body>
</html>
